#!/usr/bin/env ruby

# -*- mode: shell -*-

require 'stemcell'

DEFAULT_OPTIONS = {
  :region          => 'us-east-1',
  :instance_type   => 'm1.small',
  :image_id        => 'ami-d726abbe',
  :security_groups => 'internal',
  :git_branch      => 'production',
  :count           => 1
}

REQUIRED_PARAMETERS = [
  'aws_access_key',
  'aws_secret_key',
  'chef_role',
  'chef_environment',
  'chef_data_bag_secret',
  'git_branch',
  'git_key',
  'git_origin',
  'key_name',
]

# parse options from the command line and environment
options = Stemcell::OptionParser.new({
  :defaults => DEFAULT_OPTIONS,
  :version  => "stemcell #{Stemcell::VERSION} (c) 2013 Airbnb",
  :banner   => "Stemcell: get ready to rock"
}).parse!

REQUIRED_PARAMETERS.each do |arg|
  raise ArgumentError,
    "--#{arg.gsub('_','-')} needs to be specified on the commandline or set " \
    "by the #{arg.upcase.gsub('-','_')} environment variable" if
      options[arg].nil? or ! options[arg]
end

# create stemcell object
stemcell = Stemcell::Stemcell.new({
  'aws_access_key' => options['aws_access_key'],
  'aws_secret_key' => options['aws_secret_key'],
  'region'         => options['region'],
})

# launch instance(s)
stemcell.launch({
  'availability_zone'    => options['availability_zone'],
  'instance_type'        => options['instance_type'],
  'image_id'             => options['image_id'],
  'security_groups'      => options['security_groups'],
  'chef_role'            => options['chef_role'],
  'chef_environment'     => options['chef_environment'],
  'chef_data_bag_secret' => options['chef_data_bag_secret'],
  'git_branch'           => options['git_branch'],
  'git_key'              => options['git_key'],
  'git_origin'           => options['git_origin'],
  'key_name'             => options['key_name'],
  'tags'                 => options['tags'],
  'count'                => options['count'],
  'iam_role'             => options['iam_role'],
  'ebs_optimized'        => options['ebs_optimized'],
  'ephemeral_devices'    => options['ephemeral_devices'],
  'placement_group'      => options['placement_group'],
})
